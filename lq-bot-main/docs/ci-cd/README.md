# GitHub Actions Workflows

This directory contains all CI/CD workflows for the LingoBot project.

## Workflows Overview

### 1. **ci.yml** - Continuous Integration
**Trigger**: On push or PR to `main`, `staging`, `develop`

**What it does**:
- ‚úÖ Code quality checks (Ruff linting & formatting)
- ‚úÖ Type checking (mypy)
- ‚úÖ Security scanning (CodeQL)
- ‚úÖ Secret scanning (TruffleHog)
- ‚úÖ Dependency review (PRs only)
- ‚úÖ Unit & integration tests (Python 3.11, 3.12)
- ‚úÖ Code coverage reporting
- ‚úÖ Docker build test

**When to use**: Automatically runs on all PRs and pushes

**Expected runtime**: ~8-10 minutes

---

### 2. **deploy-staging.yml** - Deploy to QA
**Trigger**: On push to `staging` branch

**What it does**:
1. Runs full CI checks
2. Builds Docker image
3. Pushes to GitHub Container Registry
4. Deploys to DigitalOcean staging environment
5. Runs health checks
6. Posts deployment notification

**When to use**: Automatic on push to staging

**Expected runtime**: ~10-12 minutes

**Manual trigger**:
```bash
gh workflow run deploy-staging.yml --ref staging
```

---

### 3. **deploy-production.yml** - Deploy to Production
**Trigger**: On push to `main` branch

**What it does**:
1. Runs full CI checks
2. Builds Docker image with production tags
3. Pushes to GitHub Container Registry
4. Deploys to DigitalOcean production environment
5. Runs health checks
6. Runs smoke tests
7. Posts deployment notification

**When to use**: Automatic on push to main

**Expected runtime**: ~12-15 minutes

**Manual trigger**:
```bash
gh workflow run deploy-production.yml --ref main
```

**Protection**: Requires environment approval (configured in Settings ‚Üí Environments ‚Üí production)

---

### 4. **pr-checks.yml** - Pull Request Checks
**Trigger**: On PR open, sync, or reopen

**What it does**:
- üìè Adds size label to PR (XS/S/M/L/XL)
- üîç Runs quick lint checks
- üìä Posts coverage report as PR comment
- üí¨ Comments on PR if issues found

**When to use**: Automatically runs on all PRs

**Expected runtime**: ~3-5 minutes

---

## Workflow Dependencies

```
PR Created
    ‚îÇ
    ‚îú‚îÄ‚Üí pr-checks.yml (Quick checks + coverage comment)
    ‚îî‚îÄ‚Üí ci.yml (Full CI pipeline)
         ‚îÇ
         ‚îî‚îÄ‚Üí Required to pass before merge

Merge to staging
    ‚îÇ
    ‚îî‚îÄ‚Üí deploy-staging.yml
         ‚îú‚îÄ‚Üí Runs ci.yml
         ‚îî‚îÄ‚Üí Deploys to DO staging

Merge to main
    ‚îÇ
    ‚îî‚îÄ‚Üí deploy-production.yml
         ‚îú‚îÄ‚Üí Runs ci.yml
         ‚îî‚îÄ‚Üí Deploys to DO production
```

## Required Secrets

Configure in `Settings` ‚Üí `Secrets and variables` ‚Üí `Actions`:

```bash
# DigitalOcean
DIGITALOCEAN_ACCESS_TOKEN     # DO API token
DO_APP_ID_STAGING             # Staging app UUID
DO_APP_ID_PRODUCTION          # Production app UUID

# Automatically available
GITHUB_TOKEN                  # Auto-generated by GitHub
```

## Required Permissions

Workflows have these permissions:

```yaml
permissions:
  contents: read           # Read repository code
  packages: write          # Push to GHCR
  security-events: write   # CodeQL results
  pull-requests: write     # Comment on PRs
  deployments: write       # Create deployments
  actions: read            # Read workflow status
```

## GitHub Enterprise Features Used

### Security Scanning
- **CodeQL Analysis**: Finds security vulnerabilities
- **Secret Scanning**: Detects committed secrets
- **Dependency Review**: Checks for vulnerable dependencies
- **Container Scanning**: SBOM and provenance

### Automation
- **Dependabot**: Auto-updates dependencies
- **Auto-labeling**: Sizes PRs automatically
- **Coverage Reports**: Posted on PRs

### Insights
- **Code Coverage**: Tracked per PR
- **Deployment History**: Per environment
- **Security Alerts**: Centralized dashboard

## Workflow Artifacts

Each workflow may produce artifacts:

### ci.yml
- Coverage reports (HTML)
- Test results
- Ruff output

### deploy-*.yml
- Docker image (pushed to GHCR)
- Deployment logs

**Download artifacts**:
```bash
# Via GitHub CLI
gh run download <run-id>

# Or in GitHub UI
Actions ‚Üí Workflow Run ‚Üí Artifacts
```

## Monitoring Workflows

### View All Runs
```bash
# Recent runs
gh run list

# Specific workflow
gh run list --workflow=ci.yml

# Watch a run
gh run watch
```

### View Logs
```bash
# Get run ID
gh run list

# View logs
gh run view <run-id> --log

# Download logs
gh run download <run-id>
```

### Re-run Failed Jobs
```bash
gh run rerun <run-id>

# Or in GitHub UI
Actions ‚Üí Failed Run ‚Üí Re-run failed jobs
```

## Debugging Workflows

### Enable Debug Logging

Add secrets:
```bash
ACTIONS_RUNNER_DEBUG=true
ACTIONS_STEP_DEBUG=true
```

### Test Workflow Locally

Use [act](https://github.com/nektos/act):

```bash
# Install act
brew install act

# Run workflow locally
act -j test

# Run with secrets
act -j test --secret-file .env
```

### Common Issues

#### "Workflow not found"
- Check workflow file syntax
- Ensure `on:` triggers are correct
- Check for YAML indentation errors

#### "Permission denied"
- Check workflow permissions
- Verify GitHub token has required scopes

#### "Secret not found"
- Ensure secret is set in Settings
- Check secret name matches exactly
- Secrets are case-sensitive

#### "Job failed"
- Check logs for specific error
- Verify all required tools are available
- Check dependencies are correctly specified

## Best Practices

### 1. Keep Workflows Fast
- ‚úÖ Use caching for dependencies
- ‚úÖ Run jobs in parallel when possible
- ‚úÖ Use appropriate runner sizes

### 2. Fail Fast
- ‚úÖ Run quick checks first (lint, format)
- ‚úÖ Run expensive checks last (tests, builds)
- ‚úÖ Use `fail-fast: false` for test matrices

### 3. Security
- ‚úÖ Never commit secrets to workflows
- ‚úÖ Use `GITHUB_TOKEN` when possible
- ‚úÖ Limit workflow permissions
- ‚úÖ Review third-party actions

### 4. Maintainability
- ‚úÖ Use reusable workflows
- ‚úÖ Document complex steps
- ‚úÖ Keep workflows DRY (Don't Repeat Yourself)
- ‚úÖ Use semantic job names

## Customization Examples

### Add Slack Notifications

```yaml
- name: Slack notification
  uses: slackapi/slack-github-action@v1
  with:
    webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
    payload: |
      {
        "text": "Deployment: ${{ job.status }}"
      }
```

### Add Performance Testing

```yaml
- name: Run performance tests
  run: |
    source .venv/bin/activate
    pytest tests/performance/ --benchmark-only
```

### Add Database Migrations

```yaml
- name: Run migrations
  run: |
    doctl apps run-migration ${{ secrets.DO_APP_ID_PRODUCTION }}
```

## Resources

- [GitHub Actions Docs](https://docs.github.com/en/actions)
- [Workflow Syntax](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions)
- [GitHub CLI](https://cli.github.com/)
- [act - Local Testing](https://github.com/nektos/act)

---

**Need help?** Check [CICD_SETUP.md](../../docs/CICD_SETUP.md) for detailed setup instructions.
