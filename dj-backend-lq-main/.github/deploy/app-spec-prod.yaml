name: lq-backend-prod
region: nyc

services:
  - name: "dj-backend-prod"
    image:
      registry_type: DOCR
      repository: dj-backend
      tag: prod-latest
      deploy_on_push:
        enabled: false

    health_check:
      http_path: /health/
      initial_delay_seconds: 90
      period_seconds: 10
      timeout_seconds: 5
      success_threshold: 1
      failure_threshold: 3

    http_port: 8000

    instance_count: 3
    instance_size_slug: professional-xs

    routes:
      - path: /

    envs:
      # Core Django
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings
      - key: DEBUG
        value: "False"
      - key: ALLOWED_HOSTS
        value: .ondigitalocean.app,api.lingoquesto.com
      - key: ENVIRONMENT
        value: production
      - key: SECRET_KEY
        scope: RUN_TIME
        type: SECRET

      # Database
      - key: DATABASE_URL
        scope: RUN_TIME
        type: SECRET

      # Redis
      - key: REDIS_URL
        scope: RUN_TIME
        type: SECRET
      - key: REDIS_CACHE_URL
        scope: RUN_TIME
        type: SECRET
      - key: REDIS_CHANNEL_LAYERS_URL
        scope: RUN_TIME
        type: SECRET

      # Celery (SSL for managed Redis)
      - key: CELERY_BROKER_USE_SSL
        value: "ssl_cert_reqs=1;"
      - key: CELERY_REDIS_BACKEND_USE_SSL
        value: "ssl_cert_reqs=1;"

      # Storage (DigitalOcean Spaces / S3)
      - key: AWS_ACCESS_KEY_ID
        scope: RUN_TIME
        type: SECRET
      - key: AWS_SECRET_ACCESS_KEY
        scope: RUN_TIME
        type: SECRET
      - key: AWS_STORAGE_BUCKET_NAME
        value: "lingoquest-prod-media"
      - key: STORAGES_DEFAULT_BACKEND
        value: "storages.backends.s3boto3.S3Boto3Storage"

      # Email
      - key: EMAIL_URL
        scope: RUN_TIME
        type: SECRET

      # CORS (JWT authentication - production only HTTPS)
      - key: CORS_ALLOWED_ORIGINS
        value: "https://app.lingoquesto.com,https://www.lingoquesto.com"

      # CSRF (only for Django admin)
      - key: CSRF_TRUSTED_ORIGINS
        value: "https://api.lingoquesto.com"

      # Security Settings (strict for production)
      - key: SECURE_SSL_REDIRECT
        value: "True"
      - key: SECURE_HSTS_SECONDS
        value: "518400"  # 6 months
      - key: SECURE_HSTS_INCLUDE_SUBDOMAINS
        value: "True"
      - key: SECURE_HSTS_PRELOAD
        value: "True"

      # External APIs
      - key: LINGOBOT_API_KEY
        scope: RUN_TIME
        type: SECRET
      - key: WEBHOOK_VERIFY_TOKEN
        scope: RUN_TIME
        type: SECRET
      - key: GRAPH_API_TOKEN
        scope: RUN_TIME
        type: SECRET

      # OAuth
      - key: GOOGLE_CLIENT_ID
        scope: RUN_TIME
        type: SECRET
      - key: GOOGLE_SECRET
        scope: RUN_TIME
        type: SECRET
      - key: MICROSOFT_CLIENT_ID
        scope: RUN_TIME
        type: SECRET
      - key: MICROSOFT_SECRET
        scope: RUN_TIME
        type: SECRET

      # Frontend URL
      - key: ENDPOINT_URL_FRONTEND_ST
        value: "http://localhost:3000"
      - key: ENDPOINT_URL_FRONTEND_ADMIN
        value: "http://localhost:3001"

      # Monitoring
      - key: SENTRY_DSN
        scope: RUN_TIME
        type: SECRET

      # Development
      - key: HEADLESS_SERVE_SPECIFICATION
        value: "False"

#   - name: celery-worker
#     image:
#       registry_type: DOCR
#       repository: dj-backend
#       tag: prod-latest
#       deploy_on_push:
#         enabled: false

#     instance_count: 2
#     instance_size_slug: professional-xs

#     run_command: "celery -A config worker --loglevel=info --concurrency=8"

#     envs:
#       - key: DJANGO_SETTINGS_MODULE
#         value: config.settings
#       - key: DEBUG
#         value: "False"
#       - key: ENVIRONMENT
#         value: production
#       - key: SECRET_KEY
#         scope: RUN_TIME
#         type: SECRET
#       - key: DATABASE_URL
#         scope: RUN_TIME
#         type: SECRET
#       - key: REDIS_URL
#         scope: RUN_TIME
#         type: SECRET
#       - key: CELERY_BROKER_URL
#         scope: RUN_TIME
#         type: SECRET
#       - key: CELERY_RESULT_BACKEND
#         scope: RUN_TIME
#         type: SECRET
#       - key: SENTRY_DSN
#         scope: RUN_TIME
#         type: SECRET

#   - name: celery-beat
#     image:
#       registry_type: DOCR
#       repository: dj-backend
#       tag: prod-latest
#       deploy_on_push:
#         enabled: false

#     instance_count: 1
#     instance_size_slug: basic-xxs

#     run_command: "celery -A config beat --loglevel=info"

#     envs:
#       - key: DJANGO_SETTINGS_MODULE
#         value: config.settings
#       - key: DEBUG
#         value: "False"
#       - key: ENVIRONMENT
#         value: production
#       - key: SECRET_KEY
#         scope: RUN_TIME
#         type: SECRET
#       - key: DATABASE_URL
#         scope: RUN_TIME
#         type: SECRET
#       - key: REDIS_URL
#         scope: RUN_TIME
#         type: SECRET
#       - key: CELERY_BROKER_URL
#         scope: RUN_TIME
#         type: SECRET

# databases:
#   - name: db
#     engine: PG
#     version: "16"
#     production: true
#     cluster_name: lingoquest-prod-db

#   - name: redis
#     engine: REDIS
#     version: "7"
#     production: true
